<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>Murder Mystery ออนไลน์ (4-6 คน)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
  :root {--bg:#1f1f2e; --card:#2d2d44; --accent:#ffb86c; --btn:#5c4fff; --radius:10px; --shadow:0 10px 30px rgba(0,0,0,0.3);}
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:#e8e8f8;min-height:100vh;display:flex;flex-direction:column;}
  .container{max-width:900px;width:100%;margin:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
  h1{margin:0;font-size:1.8rem;text-align:center;}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);}
  .row{display:flex;gap:12px;flex-wrap:wrap;}
  button{background:var(--btn);color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;}
  input{padding:8px;border-radius:6px;border:none;flex:1;font-size:1rem;}
  .small{font-size:0.75rem;opacity:0.85;}
  .badge{display:inline-block;padding:5px 12px;border-radius:12px;background:var(--accent);font-weight:600;margin-right:6px;font-size:0.7rem;}
  .hidden{display:none;}
  .role-box{background:#111833;padding:14px;border-radius:8px;margin-bottom:8px;}
  .player-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
  .pill{background:#444;border-radius:999px;padding:6px 12px;font-size:0.75rem;display:inline-flex;align-items:center;gap:6px;}
  .highlight{outline:3px solid var(--accent);}
  .phase{font-weight:700;margin-bottom:4px;}
  .vote-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px;}
  .note{background:#222;border-radius:6px;padding:8px;margin-top:4px;font-size:0.75rem;}
  .link-box{display:flex;gap:6px;flex-wrap:wrap;}
  .flex{display:flex;gap:8px;align-items:center;}
</style>
</head>
<body>
<div class="container">
  <h1>Murder Mystery ออนไลน์ (4–6 คน)</h1>

  <div class="card" id="roomSetup">
    <div class="flex">
      <div>
        <button id="createRoomBtn">สร้างห้องใหม่</button>
      </div>
      <div style="flex:1;">
        <input type="text" id="shareLink" readonly placeholder="ลิงก์แชร์จะปรากฏที่นี่" />
      </div>
      <div>
        <button id="copyLinkBtn">คัดลอก</button>
      </div>
    </div>
    <div class="small">ส่งลิงก์ให้เพื่อน เช่น <code>?room=ABC123&name=เก้า</code> เพื่อเข้าห้องเดียวกัน</div>
    <div class="note">
      <div><strong>ขั้นตอนเบื้องต้น:</strong></div>
      <ol>
        <li>สร้างโปรเจกต์ที่ Firebase Console แล้วเปิด Realtime Database</li>
        <li>คัดลอก <strong>config</strong> ด้านล่างแล้วใส่แทนที่ในตัวแปร <code>firebaseConfig</code></li>
        <li>ตั้งกฎชั่วคราวตอนพัฒนา (ดูคำอธิบายด้านล่าง)</li>
        <li>แชร์ลิงก์ห้องให้เพื่อนเข้าร่วม</li>
      </ol>
    </div>
  </div>

  <div class="card" id="statusCard">
    <div id="roomInfo" class="flex">
      <div>รหัสห้อง: <span id="roomIdDisplay" style="font-weight:600;"></span></div>
      <div>ชื่อคุณ: <span id="playerNameDisplay" style="font-weight:600;"></span></div>
      <div>บท: <span id="yourRole" style="font-weight:600;"></span></div>
      <div>เฟส: <span id="phaseDisplay" style="font-weight:600;"></span></div>
    </div>
    <div id="playersContainer" class="player-list"></div>
    <div><button id="assignRolesBtn">แจกบท (โฮสต์)</button></div>
  </div>

  <div class="card" id="gameArea">
    <div id="stageArea">
      <div class="small">รอผู้เล่น / เริ่มเกม</div>
    </div>
  </div>

  <div class="card">
    <div class="small">
      <strong>บท:</strong> ฆาตกร = ฆ่า, หมอ = ปกป้อง, นักสืบ = ตรวจสอบ, ผู้บริสุทธิ์ = ไม่มีพิเศษ<br/>
      ระบบเป็นแบบ trust model เบื้องต้น (ถ้าต้องการปลอดภัยเพิ่ม Firebase Authentication และปรับ rules)
    </div>
    <div class="note">
      ตัวอย่าง Realtime DB rules ชั่วคราว (พัฒนา):
      <pre style="background:#0f1733;padding:6px;border-radius:4px;">{
  "rules": {
    "rooms": {
      ".read": true,
      ".write": true
    }
  }
}</pre>
      <div>ควรปรับก่อนเผยแพร่จริง เช่นให้ผู้เล่นอ่าน/เขียนได้เฉพาะ node ของตัวเอง</div>
    </div>
  </div>

  <div class="small" style="text-align:center;">ถ้าต้องการฉันช่วยเขียนเวอร์ชัน deployable (เช่น GitHub Pages + ตัวแปร config ที่ใส่เอง) บอกมาได้เลย</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database-compat.js"></script>

<script>
// ====== ตั้งค่า Firebase (แทนที่ค่าตัวอย่างด้วยของคุณจาก Firebase Console) ======
const firebaseConfig = {
  apiKey: "AIzaSyDvF2JQ5pXMFMbOEhibhMji6Y23EQJxr_M",
  authDomain: "murder-mystery-8a1b6.firebaseapp.com",
  databaseURL: "https://murder-mystery-8a1b6-default-rtdb.firebaseio.com",
  projectId: "murder-mystery-8a1b6",
  storageBucket: "murder-mystery-8a1b6.firebasestorage.app",
  messagingSenderId: "698530266599",
  appId: "1:698530266599:web:126961398c2371684ad142",
  measurementId: "G-F4VEJ5CRB1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====== ยูทิลิตี้ ======
function makeId(len=6){ return Math.random().toString(36).substring(2,2+len).toUpperCase(); }
function q(sel){ return document.querySelector(sel); }
function el(tag, props={}, ...children){ const e=document.createElement(tag); for(const k in props) e[k]=props[k]; children.forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c); }); return e; }

// ====== สถานะหลัก ======
let roomId = null;
let playerId = null;
let playerName = null;
let role = null;
let phase = null;
let alive = true;

// ====== เริ่มต้นจาก URL params ======
const urlParams = new URLSearchParams(window.location.search);
roomId = urlParams.get('room') || makeId(5);
playerName = urlParams.get('name') || ('ผู้เล่น' + Math.floor(Math.random()*100));
playerId = localStorage.getItem('mm_player_'+roomId) || makeId(8);
localStorage.setItem('mm_player_'+roomId, playerId);

// ====== DOM refs ======
const roomIdDisplay = q('#roomIdDisplay');
const playerNameDisplay = q('#playerNameDisplay');
const yourRoleDisplay = q('#yourRole');
const phaseDisplay = q('#phaseDisplay');
const playersContainer = q('#playersContainer');
const assignRolesBtn = q('#assignRolesBtn');
const stageArea = q('#stageArea');
const shareLinkInput = q('#shareLink');
const copyLinkBtn = q('#copyLinkBtn');
const createRoomBtn = q('#createRoomBtn');

// ====== แชร์ลิงก์ ======
function updateShareLink(){
  const base = window.location.origin + window.location.pathname;
  const link = `${base}?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(playerName)}`;
  shareLinkInput.value = link;
}
copyLinkBtn.addEventListener('click', ()=>{
  shareLinkInput.select();
  navigator.clipboard.writeText(shareLinkInput.value);
  alert('คัดลอกลิงก์แล้ว');
});
createRoomBtn.addEventListener('click', ()=>{
  roomId = makeId(6);
  playerId = makeId(8);
  localStorage.setItem('mm_player_'+roomId, playerId);
  const newUrl = `${window.location.pathname}?room=${encodeURIComponent(roomId)}&name=${encodeURIComponent(playerName)}`;
  window.history.replaceState({}, '', newUrl);
  initForRoom();
});

// ====== เข้าร่วมห้องและตั้ง listener ======
function initForRoom(){
  roomIdDisplay.textContent = roomId;
  playerNameDisplay.textContent = playerName;
  updateShareLink();
  // ลงทะเบียนตัวเอง
  const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
  playerRef.update({ name: playerName, alive: true });
  // ฟัง role ของตัวเอง
  db.ref(`rooms/${roomId}/players/${playerId}/role`).on('value', snap=>{
    role = snap.val();
    yourRoleDisplay.textContent = role || 'ยังไม่มี';
    renderStage();
  });
  // ฟัง phase
  db.ref(`rooms/${roomId}/phase`).on('value', snap=>{
    phase = snap.val();
    phaseDisplay.textContent = phase || '-';
    renderStage();
  });
  // ฟังรายชื่อผู้เล่น
  db.ref(`rooms/${roomId}/players`).on('value', snap=>{
    const obj = snap.val() || {};
    renderPlayers(obj);
  });
  // ฟังคืน/วัน/โหวต/ผล
  db.ref(`rooms/${roomId}/nightActions`).on('value', ()=>{ renderStage(); });
  db.ref(`rooms/${roomId}/eliminated`).on('Value', ()=>{ renderStage(); });
  db.ref(`rooms/${roomId}/votes`).on('value', ()=>{ renderStage(); });
  db.ref(`rooms/${roomId}/result`).on('value', ()=>{ renderStage(); });
}

// แสดงผู้เล่น
function renderPlayers(playersObj){
  playersContainer.innerHTML='';
  for(const pid in playersObj){
    const p=playersObj[pid];
    const aliveMark = p.alive ? '' : ' (ตาย)';
    const pill = el('div',{className:'pill'}, `${p.name}${aliveMark}`);
    if(pid===playerId) pill.style.border='2px solid var(--accent)';
    playersContainer.appendChild(pill);
  }
}

// แจกบท
assignRolesBtn.addEventListener('click', async ()=>{
  const snap = await db.ref(`rooms/${roomId}/players`).once('value');
  const players = snap.val() || {};
  const ids = Object.keys(players);
  if(ids.length < 4){ alert('ต้องมีอย่างน้อย 4 คนเพื่อเริ่มแจกบท'); return; }
  let roles = ['ฆาตกร','หมอ','นักสืบ'];
  for(let i=3;i<ids.length;i++) roles.push('ผู้บริสุทธิ์');
  shuffleArray(roles);
  const updates = {};
  ids.forEach((pid,i)=>{
    updates[`rooms/${roomId}/players/${pid}/role`] = roles[i];
    updates[`rooms/${roomId}/players/${pid}/alive`] = true;
  });
  await db.ref().update(updates);
  await db.ref(`rooms/${roomId}/phase`).set('reveal');
  await db.ref(`rooms/${roomId}/eliminated`).set(null);
  await db.ref(`rooms/${roomId}/votes`).set(null);
  await db.ref(`rooms/${roomId}/result`).set(null);
});

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

// จัดการเฟสแสดง UI
async function renderStage(){
  stageArea.innerHTML='';
  if(!phase){
    stageArea.appendChild(el('div',{}, 'รอการแจกบทโดยโฮสต์...'));
    return;
  }
  if(phase === 'reveal'){
    if(!role){ stageArea.appendChild(el('div',{}, 'กำลังรอแจกบท...')); return; }
    const box = el('div',{className:'role-box'},
      el('div',{className:'phase'}, 'บทของคุณ:'),
      el('div',{}, role),
      el('div',{className:'small'}, getRoleDesc(role))
    );
    stageArea.appendChild(box);
    if(isHost()){
      const btnNext = el('button',{}, 'เริ่มคืน (Night)');
      btnNext.addEventListener('click', ()=>{ db.ref(`rooms/${roomId}/phase`).set('night'); });
      stageArea.appendChild(btnNext);
    } else {
      stageArea.appendChild(el('div',{}, 'รอโฮสต์เริ่มคืน...'));
    }
  } else if(phase === 'night'){
    stageArea.appendChild(el('div',{className:'phase'}, 'คืน (Night Phase)'));
    if(role === 'ฆาตกร'){
      await showNightChoice('ฆาตกร','เลือกคนที่จะฆ่า', async (targetId)=>{
        await db.ref(`rooms/${roomId}/nightActions/murdererTarget`).set(targetId);
        attemptResolveNight();
      });
    } else if(role === 'หมอ'){
      await showNightChoice('หมอ','เลือกคนที่จะปกป้อง', async (targetId)=>{
        await db.ref(`rooms/${roomId}/nightActions/doctorProtect`).set(targetId);
        attemptResolveNight();
      });
    } else if(role === 'นักสืบ'){
      await showNightChoice('นักสืบ','เลือกคนตรวจสอบ', async (targetId)=>{
        await db.ref(`rooms/${roomId}/nightActions/investigatorCheck`).set(targetId);
        attemptResolveNight();
      });
    } else {
      stageArea.appendChild(el('div',{}, 'คุณไม่มีการกระทำในคืนนี้ รอผล...'));
    }
    const naSnap = await db.ref(`rooms/${roomId}/nightActions`).once('value');
    const na = naSnap.val() || {};
    stageArea.appendChild(el('div',{className:'note'}, 'สถานะคืน: ฆาตกร→' + (na.murdererTarget ? 'เลือกแล้ว' : 'ยังไม่เลือก') + ', หมอ→' + (na.doctorProtect ? 'เลือกแล้ว' : 'ยังไม่เลือก') + ', นักสืบ→' + (na.investigatorCheck ? 'เลือกแล้ว' : 'ยังไม่เลือก')));
  } else if(phase === 'day'){
    const elimSnap = await db.ref(`rooms/${roomId}/eliminated`).once('value');
    const eliminatedId = elimSnap.val();
    if(eliminatedId){
      const playersSnap = await db.ref(`rooms/${roomId}/players`).once('value');
      const players = playersSnap.val() || {};
      const name = players[eliminatedId]?.name || 'ไม่ทราบ';
      stageArea.appendChild(el('div',{}, el('div',{className:'badge'}, 'มีคนตาย'), `ผู้เล่น ${name} ถูกเลือกโดยฆาตกร`));
      await db.ref(`rooms/${roomId}/players/${eliminatedId}/alive`).set(false);
    } else {
      stageArea.appendChild(el('div',{}, el('div',{className:'badge'}, 'ปลอดภัย'), 'ไม่มีผู้เสียชีวิต'));
    }
    stageArea.appendChild(el('div',{className:'phase'}, 'โหวตจับฆาตกร'));
    const voteGrid = el('div',{className:'vote-grid'});
    const playersSnap2 = await db.ref(`rooms/${roomId}/players`).once('value');
    const players2 = playersSnap2.val() || {};
    for(const pid in players2){
      if(!players2[pid].alive) continue;
      const btn = el('button',{}, players2[pid].name);
      btn.addEventListener('click', async ()=>{
        await db.ref(`rooms/${roomId}/votes/${playerId}`).set(pid);
        await tryTallyVotes();
      });
      voteGrid.appendChild(btn);
    }
    stageArea.appendChild(voteGrid);
    stageArea.appendChild(el('div',{className:'small'}, 'เมื่อผู้เล่นทุกคนโหวตระบบจะสรุปผลอัตโนมัติ'));
  } else if(phase === 'result'){
    const resSnap = await db.ref(`rooms/${roomId}/result`).once('value');
    const res = resSnap.val() || {};
    const murdererId = res.murderer;
    const playersSnap3 = await db.ref(`rooms/${roomId}/players`).once('value');
    const players3 = playersSnap3.val() || {};
    const murdererName = players3[murdererId]?.name || 'ไม่ทราบ';
    stageArea.appendChild(el('div',{}, el('div',{className:'badge'}, res.outcome || ''), `ฆาตกรคือ: ${murdererName}`));
    if(isHost()){
      const btn = el('button',{}, 'เริ่มรอบใหม่');
      btn.addEventListener('click', async ()=>{
        await db.ref(`rooms/${roomId}/phase`).set('reveal');
        await db.ref(`rooms/${roomId}/nightActions`).set(null);
        await db.ref(`rooms/${roomId}/eliminated`).set(null);
        await db.ref(`rooms/${roomId}/votes`).set(null);
        await db.ref(`rooms/${roomId}/result`).set(null);
      });
      stageArea.appendChild(btn);
    }
  }
}

// ตรวจว่าผู้เล่นควรทำ action คืนถัดไป
let resolvingNight = false;
async function attemptResolveNight(){
  if(resolvingNight) return;
  const naSnap = await db.ref(`rooms/${roomId}/nightActions`).once('value');
  const na = naSnap.val() || {};
  if(na.murdererTarget && na.doctorProtect && na.investigatorCheck){
    resolvingNight = true;
    // ส่งผลนักสืบ
    const investigatorResult = (await db.ref(`rooms/${roomId}/players/${na.investigatorCheck}/role`).once('value')).val() === 'ฆาตกร';
    if(role === 'นักสืบ'){
      alert('ผลนักสืบ: ผู้เล่น ' + (investigatorResult ? 'เป็นฆาตกร' : 'ไม่ใช่ฆาตกร'));
    }
    // กำหนดผู้ที่ตาย
    let eliminatedId = null;
    if(na.murdererTarget !== na.doctorProtect){
      eliminatedId = na.murdererTarget;
    }
    await db.ref(`rooms/${roomId}/eliminated`).set(eliminatedId);
    await db.ref(`rooms/${roomId}/phase`).set('day');
    resolvingNight = false;
  }
}

// ตรวจโหวตและสรุป
async function tryTallyVotes(){
  const votesSnap = await db.ref(`rooms/${roomId}/votes`).once('value');
  const votes = votesSnap.val() || {};
  const playersSnap = await db.ref(`rooms/${roomId}/players`).once('value');
  const players = playersSnap.val() || {};
  const alivePlayers = Object.entries(players).filter(([pid,p])=>p.alive).map(([pid])=>pid);
  if(Object.keys(votes).length >= alivePlayers.length){
    const counts = {};
    for(const voter in votes){
      const accused = votes[voter];
      counts[accused] = (counts[accused] || 0) + 1;
    }
    let max = -1;
    let suspects = [];
    for(const acc in counts){
      if(counts[acc] > max){ max = counts[acc]; suspects=[acc]; }
      else if(counts[acc] === max){ suspects.push(acc); }
    }
    const accusedFinal = suspects[Math.floor(Math.random()*suspects.length)];
    let murdererId = null;
    for(const pid in players){
      if(players[pid].role === 'ฆาตกร') murdererId = pid;
    }
    let outcome = '';
    if(accusedFinal === murdererId) outcome='ผู้บริสุทธิ์ชนะ';
    else outcome='ฆาตกรรอด';
    await db.ref(`rooms/${roomId}/result`).set({ outcome, murderer: murdererId });
    await db.ref(`rooms/${roomId}/phase`).set('result');
  }
}

function isHost(){ return true; } // ง่ายๆ ให้ทุกคนกดได้

// เริ่มระบบ
initForRoom();
</script>
</body>
</html>
